name: Trunk install test workflow

on:
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/trunk-install-test.yml'

jobs:
  test:
    name: Run tests
    runs-on:
      - self-hosted
      - dind
      - large-8x8
    container: quay.io/tembo/trunk-test:0.0.2
    env:
      PGHOST: "localhost"
      PGPORT: "5432"
      PGDATABASE: "postgres"
      PGUSER: "postgres"
      PGPASSWORD: "postgres"
      POSTGRES_PASSWORD: "password"

    steps:
      - name: Trunk Version
        # Entrypoint is overwritten by GitHub Action. We need to execute it manually in order to start Postgres.
        # More information here https://github.com/actions/runner/issues/1964
        run: |
          docker-entrypoint.sh postgres &
          sleep 5
          ps aux
          psql -l
          curl https://registry.pgtrunk.io/extensions/all | jq -r ".[] | .name" > /tmp/extensions.txt
          cat /tmp/extensions.txt
          trunk install pgmq
          psql -c "create extension pgmq cascade;"

          
